version: 2
jobs:
  test-node10-0:
    working_directory: ~/core
    environment:
      CORE_DB_DATABASE: core_unitnet
      CORE_DB_USERNAME: core
    docker:
      - image: 'circleci/node:10-browsers'
      - image: 'postgres:alpine'
        environment:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: core_unitnet
          POSTGRES_USER: core
    steps:
      - checkout
      - run:
          name: Apt update
          command: >-
            sudo sh -c 'echo "deb http://ftp.debian.org/debian stable main
            contrib non-free" >> /etc/apt/sources.list' && sudo apt-get update
      - run:
          name: Install xsel & postgresql-client
          command: sudo apt-get install -q xsel postgresql-client
      - run:
          name: Generate cache key
          command: >-
            find ./packages/ -name package.json -print0 | sort -z | xargs -r0
            echo ./package.json | xargs md5sum | md5sum - > checksum.txt
      - restore_cache:
          key: 'core-node10-{{ checksum "checksum.txt" }}-1'
      - run:
          name: Install and build packages
          command: yarn bootstrap && yarn build
      - save_cache:
          key: 'core-node10-{{ checksum "checksum.txt" }}-1'
          paths:
            - ./packages/core/node_modules
            - ./packages/core-api/node_modules
            - ./packages/core-blockchain/node_modules
            - ./packages/core-container/node_modules
            - ./packages/core-database/node_modules
            - ./packages/core-database-postgres/node_modules
            - ./packages/core-debugger-cli/node_modules
            - ./packages/core-elasticsearch/node_modules
            - ./packages/core-error-tracker-bugsnag/node_modules
            - ./packages/core-error-tracker-sentry/node_modules
            - ./packages/core-event-emitter/node_modules
            - ./packages/core-forger/node_modules
            - ./packages/core-graphql/node_modules
            - ./packages/core-http-utils/node_modules
            - ./packages/core-interfaces/node_modules
            - ./packages/core-jest-matchers/node_modules
            - ./packages/core-json-rpc/node_modules
            - ./packages/core-logger/node_modules
            - ./packages/core-logger-pino/node_modules
            - ./packages/core-p2p/node_modules
            - ./packages/core-snapshots/node_modules
            - ./packages/core-tester-cli/node_modules
            - ./packages/core-transaction-pool/node_modules
            - ./packages/core-utils/node_modules
            - ./packages/core-vote-report/node_modules
            - ./packages/core-webhooks/node_modules
            - ./packages/crypto/node_modules
            - ./node_modules
      - run:
          name: Create .core/database directory
          command: mkdir -p $HOME/.core/database
      - run:
          name: core-api
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-api/
      - run:
          name: core-blockchain
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-blockchain/
      - run:
          name: core-container
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-container/
      - run:
          name: core-database
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-database/
      - run:
          name: core-database-postgres
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-database-postgres/
      - run:
          name: core-debugger-cli
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-debugger-cli/
      - run:
          name: Last 1000 lines of test output
          when: on_fail
          command: tail -n 1000 test_output.txt
      - run:
          name: Lint
          command: yarn lint
      - run:
          name: Codecov
          command: ./node_modules/.bin/codecov
  test-node11-0:
    working_directory: ~/core
    environment:
      CORE_DB_DATABASE: core_unitnet
      CORE_DB_USERNAME: core
    docker:
      - image: 'circleci/node:11-browsers'
      - image: 'postgres:alpine'
        environment:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: core_unitnet
          POSTGRES_USER: core
    steps:
      - checkout
      - run:
          name: Apt update
          command: >-
            sudo sh -c 'echo "deb http://ftp.debian.org/debian stable main
            contrib non-free" >> /etc/apt/sources.list' && sudo apt-get update
      - run:
          name: Install xsel & postgresql-client
          command: sudo apt-get install -q xsel postgresql-client
      - run:
          name: Generate cache key
          command: >-
            find ./packages/ -name package.json -print0 | sort -z | xargs -r0
            echo ./package.json | xargs md5sum | md5sum - > checksum.txt
      - restore_cache:
          key: 'core-node11-{{ checksum "checksum.txt" }}-1'
      - run:
          name: Install and build packages
          command: yarn bootstrap && yarn build
      - save_cache:
          key: 'core-node11-{{ checksum "checksum.txt" }}-1'
          paths:
            - ./packages/core/node_modules
            - ./packages/core-api/node_modules
            - ./packages/core-blockchain/node_modules
            - ./packages/core-container/node_modules
            - ./packages/core-database/node_modules
            - ./packages/core-database-postgres/node_modules
            - ./packages/core-debugger-cli/node_modules
            - ./packages/core-elasticsearch/node_modules
            - ./packages/core-error-tracker-bugsnag/node_modules
            - ./packages/core-error-tracker-sentry/node_modules
            - ./packages/core-event-emitter/node_modules
            - ./packages/core-forger/node_modules
            - ./packages/core-graphql/node_modules
            - ./packages/core-http-utils/node_modules
            - ./packages/core-interfaces/node_modules
            - ./packages/core-jest-matchers/node_modules
            - ./packages/core-json-rpc/node_modules
            - ./packages/core-logger/node_modules
            - ./packages/core-logger-pino/node_modules
            - ./packages/core-p2p/node_modules
            - ./packages/core-snapshots/node_modules
            - ./packages/core-tester-cli/node_modules
            - ./packages/core-transaction-pool/node_modules
            - ./packages/core-utils/node_modules
            - ./packages/core-vote-report/node_modules
            - ./packages/core-webhooks/node_modules
            - ./packages/crypto/node_modules
            - ./node_modules
      - run:
          name: Create .core/database directory
          command: mkdir -p $HOME/.core/database
      - run:
          name: core-api
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-api/
      - run:
          name: core-blockchain
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-blockchain/
      - run:
          name: core-container
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-container/
      - run:
          name: core-database
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-database/
      - run:
          name: core-database-postgres
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-database-postgres/
      - run:
          name: core-debugger-cli
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-debugger-cli/
      - run:
          name: Last 1000 lines of test output
          when: on_fail
          command: tail -n 1000 test_output.txt
      - run:
          name: Lint
          command: yarn lint
      - run:
          name: Codecov
          command: ./node_modules/.bin/codecov
  test-node10-1:
    working_directory: ~/core
    environment:
      CORE_DB_DATABASE: core_unitnet
      CORE_DB_USERNAME: core
    docker:
      - image: 'circleci/node:10-browsers'
      - image: 'postgres:alpine'
        environment:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: core_unitnet
          POSTGRES_USER: core
    steps:
      - checkout
      - run:
          name: Apt update
          command: >-
            sudo sh -c 'echo "deb http://ftp.debian.org/debian stable main
            contrib non-free" >> /etc/apt/sources.list' && sudo apt-get update
      - run:
          name: Install xsel & postgresql-client
          command: sudo apt-get install -q xsel postgresql-client
      - run:
          name: Generate cache key
          command: >-
            find ./packages/ -name package.json -print0 | sort -z | xargs -r0
            echo ./package.json | xargs md5sum | md5sum - > checksum.txt
      - restore_cache:
          key: 'core-node10-{{ checksum "checksum.txt" }}-1'
      - run:
          name: Install and build packages
          command: yarn bootstrap && yarn build
      - save_cache:
          key: 'core-node10-{{ checksum "checksum.txt" }}-1'
          paths:
            - ./packages/core/node_modules
            - ./packages/core-api/node_modules
            - ./packages/core-blockchain/node_modules
            - ./packages/core-container/node_modules
            - ./packages/core-database/node_modules
            - ./packages/core-database-postgres/node_modules
            - ./packages/core-debugger-cli/node_modules
            - ./packages/core-elasticsearch/node_modules
            - ./packages/core-error-tracker-bugsnag/node_modules
            - ./packages/core-error-tracker-sentry/node_modules
            - ./packages/core-event-emitter/node_modules
            - ./packages/core-forger/node_modules
            - ./packages/core-graphql/node_modules
            - ./packages/core-http-utils/node_modules
            - ./packages/core-interfaces/node_modules
            - ./packages/core-jest-matchers/node_modules
            - ./packages/core-json-rpc/node_modules
            - ./packages/core-logger/node_modules
            - ./packages/core-logger-pino/node_modules
            - ./packages/core-p2p/node_modules
            - ./packages/core-snapshots/node_modules
            - ./packages/core-tester-cli/node_modules
            - ./packages/core-transaction-pool/node_modules
            - ./packages/core-utils/node_modules
            - ./packages/core-vote-report/node_modules
            - ./packages/core-webhooks/node_modules
            - ./packages/crypto/node_modules
            - ./node_modules
      - run:
          name: Create .core/database directory
          command: mkdir -p $HOME/.core/database
      - run:
          name: core-event-emitter
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-event-emitter/
      - run:
          name: core-forger
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-forger/
      - run:
          name: core-graphql
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-graphql/
      - run:
          name: core-http-utils
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-http-utils/
      - run:
          name: core-jest-matchers
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-jest-matchers/
      - run:
          name: core-json-rpc
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-json-rpc/
      - run:
          name: core-logger
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-logger/
      - run:
          name: core-logger-pino
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-logger-pino/
      - run:
          name: core-p2p
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-p2p/
      - run:
          name: Last 1000 lines of test output
          when: on_fail
          command: tail -n 1000 test_output.txt
      - run:
          name: Lint
          command: yarn lint
      - run:
          name: Codecov
          command: ./node_modules/.bin/codecov
  test-node10-2:
    working_directory: ~/core
    environment:
      CORE_DB_DATABASE: core_unitnet
      CORE_DB_USERNAME: core
    docker:
      - image: 'circleci/node:10-browsers'
      - image: 'postgres:alpine'
        environment:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: core_unitnet
          POSTGRES_USER: core
    steps:
      - checkout
      - run:
          name: Apt update
          command: >-
            sudo sh -c 'echo "deb http://ftp.debian.org/debian stable main
            contrib non-free" >> /etc/apt/sources.list' && sudo apt-get update
      - run:
          name: Install xsel & postgresql-client
          command: sudo apt-get install -q xsel postgresql-client
      - run:
          name: Generate cache key
          command: >-
            find ./packages/ -name package.json -print0 | sort -z | xargs -r0
            echo ./package.json | xargs md5sum | md5sum - > checksum.txt
      - restore_cache:
          key: 'core-node10-{{ checksum "checksum.txt" }}-1'
      - run:
          name: Install and build packages
          command: yarn bootstrap && yarn build
      - save_cache:
          key: 'core-node10-{{ checksum "checksum.txt" }}-1'
          paths:
            - ./packages/core/node_modules
            - ./packages/core-api/node_modules
            - ./packages/core-blockchain/node_modules
            - ./packages/core-container/node_modules
            - ./packages/core-database/node_modules
            - ./packages/core-database-postgres/node_modules
            - ./packages/core-debugger-cli/node_modules
            - ./packages/core-elasticsearch/node_modules
            - ./packages/core-error-tracker-bugsnag/node_modules
            - ./packages/core-error-tracker-sentry/node_modules
            - ./packages/core-event-emitter/node_modules
            - ./packages/core-forger/node_modules
            - ./packages/core-graphql/node_modules
            - ./packages/core-http-utils/node_modules
            - ./packages/core-interfaces/node_modules
            - ./packages/core-jest-matchers/node_modules
            - ./packages/core-json-rpc/node_modules
            - ./packages/core-logger/node_modules
            - ./packages/core-logger-pino/node_modules
            - ./packages/core-p2p/node_modules
            - ./packages/core-snapshots/node_modules
            - ./packages/core-tester-cli/node_modules
            - ./packages/core-transaction-pool/node_modules
            - ./packages/core-utils/node_modules
            - ./packages/core-vote-report/node_modules
            - ./packages/core-webhooks/node_modules
            - ./packages/crypto/node_modules
            - ./node_modules
      - run:
          name: Create .core/database directory
          command: mkdir -p $HOME/.core/database
      - run:
          name: core-snapshots
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-snapshots/
      - run:
          name: core-tester-cli
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-tester-cli/
      - run:
          name: core-transaction-pool
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-transaction-pool/
      - run:
          name: core-utils
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-utils/
      - run:
          name: core-vote-report
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-vote-report/
      - run:
          name: core-webhooks
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-webhooks/
      - run:
          name: crypto
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /crypto/
      - run:
          name: Last 1000 lines of test output
          when: on_fail
          command: tail -n 1000 test_output.txt
      - run:
          name: Lint
          command: yarn lint
      - run:
          name: Codecov
          command: ./node_modules/.bin/codecov
  test-node11-1:
    working_directory: ~/core
    environment:
      CORE_DB_DATABASE: core_unitnet
      CORE_DB_USERNAME: core
    docker:
      - image: 'circleci/node:11-browsers'
      - image: 'postgres:alpine'
        environment:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: core_unitnet
          POSTGRES_USER: core
    steps:
      - checkout
      - run:
          name: Apt update
          command: >-
            sudo sh -c 'echo "deb http://ftp.debian.org/debian stable main
            contrib non-free" >> /etc/apt/sources.list' && sudo apt-get update
      - run:
          name: Install xsel & postgresql-client
          command: sudo apt-get install -q xsel postgresql-client
      - run:
          name: Generate cache key
          command: >-
            find ./packages/ -name package.json -print0 | sort -z | xargs -r0
            echo ./package.json | xargs md5sum | md5sum - > checksum.txt
      - restore_cache:
          key: 'core-node11-{{ checksum "checksum.txt" }}-1'
      - run:
          name: Install and build packages
          command: yarn bootstrap && yarn build
      - save_cache:
          key: 'core-node11-{{ checksum "checksum.txt" }}-1'
          paths:
            - ./packages/core/node_modules
            - ./packages/core-api/node_modules
            - ./packages/core-blockchain/node_modules
            - ./packages/core-container/node_modules
            - ./packages/core-database/node_modules
            - ./packages/core-database-postgres/node_modules
            - ./packages/core-debugger-cli/node_modules
            - ./packages/core-elasticsearch/node_modules
            - ./packages/core-error-tracker-bugsnag/node_modules
            - ./packages/core-error-tracker-sentry/node_modules
            - ./packages/core-event-emitter/node_modules
            - ./packages/core-forger/node_modules
            - ./packages/core-graphql/node_modules
            - ./packages/core-http-utils/node_modules
            - ./packages/core-interfaces/node_modules
            - ./packages/core-jest-matchers/node_modules
            - ./packages/core-json-rpc/node_modules
            - ./packages/core-logger/node_modules
            - ./packages/core-logger-pino/node_modules
            - ./packages/core-p2p/node_modules
            - ./packages/core-snapshots/node_modules
            - ./packages/core-tester-cli/node_modules
            - ./packages/core-transaction-pool/node_modules
            - ./packages/core-utils/node_modules
            - ./packages/core-vote-report/node_modules
            - ./packages/core-webhooks/node_modules
            - ./packages/crypto/node_modules
            - ./node_modules
      - run:
          name: Create .core/database directory
          command: mkdir -p $HOME/.core/database
      - run:
          name: core-event-emitter
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-event-emitter/
      - run:
          name: core-forger
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-forger/
      - run:
          name: core-graphql
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-graphql/
      - run:
          name: core-http-utils
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-http-utils/
      - run:
          name: core-jest-matchers
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-jest-matchers/
      - run:
          name: core-json-rpc
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-json-rpc/
      - run:
          name: core-logger
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-logger/
      - run:
          name: core-logger-pino
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-logger-pino/
      - run:
          name: core-p2p
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-p2p/
      - run:
          name: Last 1000 lines of test output
          when: on_fail
          command: tail -n 1000 test_output.txt
      - run:
          name: Lint
          command: yarn lint
      - run:
          name: Codecov
          command: ./node_modules/.bin/codecov
  test-node11-2:
    working_directory: ~/core
    environment:
      CORE_DB_DATABASE: core_unitnet
      CORE_DB_USERNAME: core
    docker:
      - image: 'circleci/node:11-browsers'
      - image: 'postgres:alpine'
        environment:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: core_unitnet
          POSTGRES_USER: core
    steps:
      - checkout
      - run:
          name: Apt update
          command: >-
            sudo sh -c 'echo "deb http://ftp.debian.org/debian stable main
            contrib non-free" >> /etc/apt/sources.list' && sudo apt-get update
      - run:
          name: Install xsel & postgresql-client
          command: sudo apt-get install -q xsel postgresql-client
      - run:
          name: Generate cache key
          command: >-
            find ./packages/ -name package.json -print0 | sort -z | xargs -r0
            echo ./package.json | xargs md5sum | md5sum - > checksum.txt
      - restore_cache:
          key: 'core-node11-{{ checksum "checksum.txt" }}-1'
      - run:
          name: Install and build packages
          command: yarn bootstrap && yarn build
      - save_cache:
          key: 'core-node11-{{ checksum "checksum.txt" }}-1'
          paths:
            - ./packages/core/node_modules
            - ./packages/core-api/node_modules
            - ./packages/core-blockchain/node_modules
            - ./packages/core-container/node_modules
            - ./packages/core-database/node_modules
            - ./packages/core-database-postgres/node_modules
            - ./packages/core-debugger-cli/node_modules
            - ./packages/core-elasticsearch/node_modules
            - ./packages/core-error-tracker-bugsnag/node_modules
            - ./packages/core-error-tracker-sentry/node_modules
            - ./packages/core-event-emitter/node_modules
            - ./packages/core-forger/node_modules
            - ./packages/core-graphql/node_modules
            - ./packages/core-http-utils/node_modules
            - ./packages/core-interfaces/node_modules
            - ./packages/core-jest-matchers/node_modules
            - ./packages/core-json-rpc/node_modules
            - ./packages/core-logger/node_modules
            - ./packages/core-logger-pino/node_modules
            - ./packages/core-p2p/node_modules
            - ./packages/core-snapshots/node_modules
            - ./packages/core-tester-cli/node_modules
            - ./packages/core-transaction-pool/node_modules
            - ./packages/core-utils/node_modules
            - ./packages/core-vote-report/node_modules
            - ./packages/core-webhooks/node_modules
            - ./packages/crypto/node_modules
            - ./node_modules
      - run:
          name: Create .core/database directory
          command: mkdir -p $HOME/.core/database
      - run:
          name: core-snapshots
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-snapshots/
      - run:
          name: core-tester-cli
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-tester-cli/
      - run:
          name: core-transaction-pool
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-transaction-pool/
      - run:
          name: core-utils
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-utils/
      - run:
          name: core-vote-report
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-vote-report/
      - run:
          name: core-webhooks
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /core-webhooks/
      - run:
          name: crypto
          command: >-
            cd ~/core/.circleci && ./rebuild-db.sh && cd ~/core && yarn
            test:coverage /crypto/
      - run:
          name: Last 1000 lines of test output
          when: on_fail
          command: tail -n 1000 test_output.txt
      - run:
          name: Lint
          command: yarn lint
      - run:
          name: Codecov
          command: ./node_modules/.bin/codecov
workflows:
  version: 2
  build_and_test:
    jobs:
      - test-node10-0
      - test-node10-1
      - test-node10-2
      - test-node11-0
      - test-node11-1
      - test-node11-2
