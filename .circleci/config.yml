version: 2
jobs:
    test-node10-unit:
        working_directory: ~/core
        docker:
            - image: "circleci/node:10"
        steps: &stepsUnit
            - checkout
            - run:
                  name: Apt update
                  command: >-
                      sudo sh -c 'echo "deb http://ftp.debian.org/debian stable main
                      contrib non-free" >> /etc/apt/sources.list' && sudo apt-get update
            - run:
                  name: Install xsel
                  command: sudo apt-get install -q xsel
            - run:
                  name: Generate cache key
                  command: >-
                      find ./packages/ -name package.json -print0 | sort -z | xargs -r0
                      echo ./package.json ./__tests__/e2e/package.json | xargs md5sum |
                      md5sum - > checksum.txt
            - restore_cache:
                  keys:
                      - v1-dependencies-{{ checksum "yarn.lock" }}
                      - v1-dependencies-
            - run:
                  name: Install and build packages
                  command: yarn setup
            - save_cache:
                  paths:
                      - node_modules
                  key: v1-dependencies-{{ checksum "yarn.lock" }}
            - run:
                  name: Create .core/database directory
                  command: mkdir -p $HOME/.core/database
            - run:
                  name: Unit tests
                  command: >-
                      cd ~/core && yarn test:unit:coverage --coverageDirectory
                      .coverage/unit/ --maxWorkers=2
            - run:
                  name: Last 1000 lines of test output
                  when: on_fail
                  command: tail -n 1000 test_output.txt
            - run:
                  name: Lint
                  command: yarn lint
            - run:
                  name: Codecov
                  command: ./node_modules/.bin/codecov
    test-node11-unit:
        working_directory: ~/core
        docker:
            - image: "circleci/node:11"
        steps: *stepsUnit
    test-node12-unit:
        working_directory: ~/core
        docker:
            - image: "circleci/node:12"
        steps: *stepsUnit
    test-node10-functional:
        working_directory: ~/core
        environment:
            CORE_DB_DATABASE: ark_unitnet
            CORE_DB_USERNAME: ark
        docker:
            - image: "circleci/node:10"
            - image: "postgres:alpine"
              environment:
                  POSTGRES_PASSWORD: password
                  POSTGRES_DB: ark_unitnet
                  POSTGRES_USER: ark
        steps: &stepsFunctional
            - checkout
            - run:
                  name: Apt update
                  command: >-
                      sudo sh -c 'echo "deb http://ftp.debian.org/debian stable main
                      contrib non-free" >> /etc/apt/sources.list' && sudo apt-get update
            - run:
                  name: Install xsel & postgresql-client
                  command: sudo apt-get install -q xsel postgresql-client
            - restore_cache:
                  keys:
                      - v1-dependencies-{{ checksum "yarn.lock" }}
                      - v1-dependencies-
            - run:
                  name: Install and build packages
                  command: yarn setup
            - save_cache:
                  paths:
                      - node_modules
                  key: v1-dependencies-{{ checksum "yarn.lock" }}
            - run:
                  name: Create .core/database directory
                  command: mkdir -p $HOME/.core/database
            - run:
                  name: Functional tests
                  command: >-
                      cd ~/core && yarn test:functional:coverage --coverageDirectory
                      .coverage/functional/
            - run:
                  name: Last 1000 lines of test output
                  when: on_fail
                  command: tail -n 1000 test_output.txt
            - run:
                  name: Lint
                  command: yarn lint
            - run:
                  name: Codecov
                  command: ./node_modules/.bin/codecov
    test-node11-functional:
        working_directory: ~/core
        environment:
            CORE_DB_DATABASE: ark_unitnet
            CORE_DB_USERNAME: ark
        docker:
            - image: "circleci/node:11"
            - image: "postgres:alpine"
              environment:
                  POSTGRES_PASSWORD: password
                  POSTGRES_DB: ark_unitnet
                  POSTGRES_USER: ark
        steps: *stepsFunctional
    test-node12-functional:
        working_directory: ~/core
        environment:
            CORE_DB_DATABASE: ark_unitnet
            CORE_DB_USERNAME: ark
        docker:
            - image: "circleci/node:12"
            - image: "postgres:alpine"
              environment:
                  POSTGRES_PASSWORD: password
                  POSTGRES_DB: ark_unitnet
                  POSTGRES_USER: ark
        steps: *stepsFunctional
    test-node10-integration:
        working_directory: ~/core
        environment:
            CORE_DB_DATABASE: ark_unitnet
            CORE_DB_USERNAME: ark
        docker:
            - image: "circleci/node:10"
            - image: "postgres:alpine"
              environment:
                  POSTGRES_PASSWORD: password
                  POSTGRES_DB: ark_unitnet
                  POSTGRES_USER: ark
        steps: &stepsIntegration
            - checkout
            - run:
                  name: Apt update
                  command: >-
                      sudo sh -c 'echo "deb http://ftp.debian.org/debian stable main
                      contrib non-free" >> /etc/apt/sources.list' && sudo apt-get update
            - run:
                  name: Install xsel & postgresql-client
                  command: sudo apt-get install -q xsel postgresql-client
            - restore_cache:
                  keys:
                      - v1-dependencies-{{ checksum "yarn.lock" }}
                      - v1-dependencies-
            - run:
                  name: Install and build packages
                  command: yarn setup
            - save_cache:
                  paths:
                      - node_modules
                  key: v1-dependencies-{{ checksum "yarn.lock" }}
            - run:
                  name: Create .core/database directory
                  command: mkdir -p $HOME/.core/database
            - run:
                  name: Integration tests
                  command: >-
                      cd ~/core/.circleci && ./rebuild-db.sh && yarn
                      test:integration:coverage --coverageDirectory .coverage/integration/
            - run:
                  name: Last 1000 lines of test output
                  when: on_fail
                  command: tail -n 1000 test_output.txt
            - run:
                  name: Lint
                  command: yarn lint
            - run:
                  name: Codecov
                  command: ./node_modules/.bin/codecov
    test-node11-integration:
        working_directory: ~/core
        environment:
            CORE_DB_DATABASE: ark_unitnet
            CORE_DB_USERNAME: ark
        docker:
            - image: "circleci/node:11"
            - image: "postgres:alpine"
              environment:
                  POSTGRES_PASSWORD: password
                  POSTGRES_DB: ark_unitnet
                  POSTGRES_USER: ark
        steps: *stepsIntegration
    test-node12-integration:
        working_directory: ~/core
        environment:
            CORE_DB_DATABASE: ark_unitnet
            CORE_DB_USERNAME: ark
        docker:
            - image: "circleci/node:12"
            - image: "postgres:alpine"
              environment:
                  POSTGRES_PASSWORD: password
                  POSTGRES_DB: ark_unitnet
                  POSTGRES_USER: ark
        steps: *stepsIntegration
    test-node10-benchmark:
        working_directory: ~/core
        docker:
            - image: "circleci/node:10"
        steps: &stepsBenchmark
            - checkout
            - run:
                  name: Apt update
                  command: >-
                      sudo sh -c 'echo "deb http://ftp.debian.org/debian stable main
                      contrib non-free" >> /etc/apt/sources.list' && sudo apt-get update
            - restore_cache:
                  keys:
                      - v1-dependencies-{{ checksum "yarn.lock" }}
                      - v1-dependencies-
            - run:
                  name: Install and build packages
                  command: yarn setup
            - save_cache:
                  paths:
                      - node_modules
                  key: v1-dependencies-{{ checksum "yarn.lock" }}
            - run:
                  name: Benchmark
                  command: cd ~/core && yarn bench
    test-node11-benchmark:
        working_directory: ~/core
        docker:
            - image: "circleci/node:11"
        steps: *stepsBenchmark
    test-node12-benchmark:
        working_directory: ~/core
        docker:
            - image: "circleci/node:12"
        steps: *stepsBenchmark
    # TODO: make e2e reusable
    test-node10-e2e:
        machine: true
        steps:
            - checkout
            - run:
                  name: Install nvm 10
                  command: source ~/.bashrc && nvm install 10 && nvm use 10
            - restore_cache:
                  keys:
                      - v1-dependencies-{{ checksum "yarn.lock" }}
                      - v1-dependencies-
            - run:
                  name: Install yarn
                  command: >-
                      curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add
                      - && echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo
                      tee /etc/apt/sources.list.d/yarn.list && sudo apt-get update && sudo
                      apt-get install yarn
            - run:
                  name: Docker swarm init
                  command: docker swarm init
            - run:
                  name: Install and build packages
                  command: >-
                      source ~/.bashrc && nvm use 10 && yarn && yarn bootstrap && yarn
                      build && cd __tests__/e2e && yarn install
            - save_cache:
                  paths:
                      - node_modules
                  key: v1-dependencies-{{ checksum "yarn.lock" }}
            - run:
                  name: Generate files
                  command: >-
                      source ~/.bashrc && nvm use 10 && node --version && cd __tests__/e2e
                      && yarn generate -c 3 -v 10
            - run:
                  name: Make scripts executable
                  command: >-
                      sudo chmod +x __tests__/e2e/dist/docker* && sudo chmod +x
                      __tests__/e2e/dist/node0/docker/testnet-e2e/entrypoint.sh && sudo
                      chmod +x __tests__/e2e/dist/node1/docker/testnet-e2e/entrypoint.sh
                      && sudo chmod +x
                      __tests__/e2e/dist/node2/docker/testnet-e2e/entrypoint.sh && sudo
                      chmod +x __tests__/e2e/dist/node0/ark.sh && sudo chmod +x
                      __tests__/e2e/dist/node1/ark.sh && sudo chmod +x
                      __tests__/e2e/dist/node2/ark.sh
            - run:
                  name: Docker init and start
                  command: cd __tests__/e2e/dist && ./docker-init.sh && ./docker-start.sh
            - run:
                  name: Wait 10 sec for docker containers to be up
                  command: sleep 10
            - run:
                  name: Run tests
                  command: >-
                      cd __tests__/e2e && sudo chown -R $USER:$USER ./dist/ && source
                      ~/.bashrc && nvm use 10 && yarn run-tests -s scenario1
            - run:
                  name: Output results - node0
                  when: always
                  command: >-
                      cat __tests__/e2e/dist/node0/output.log && cat
                      __tests__/e2e/dist/node0/errors.log
            - run:
                  name: Output results - node1
                  when: always
                  command: >-
                      cat __tests__/e2e/dist/node1/output.log && cat
                      __tests__/e2e/dist/node1/errors.log
            - run:
                  name: Output results - node2
                  when: always
                  command: >-
                      cat __tests__/e2e/dist/node2/output.log && cat
                      __tests__/e2e/dist/node2/errors.log
    test-node11-e2e:
        machine: true
        steps:
            - checkout
            - run:
                  name: Install nvm 11
                  command: source ~/.bashrc && nvm install 11 && nvm use 11
            - restore_cache:
                  keys:
                      - v1-dependencies-{{ checksum "yarn.lock" }}
                      - v1-dependencies-
            - run:
                  name: Install yarn
                  command: >-
                      curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add
                      - && echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo
                      tee /etc/apt/sources.list.d/yarn.list && sudo apt-get update && sudo
                      apt-get install yarn
            - run:
                  name: Docker swarm init
                  command: docker swarm init
            - run:
                  name: Install and build packages
                  command: >-
                      source ~/.bashrc && nvm use 11 && yarn && yarn bootstrap && yarn
                      build && cd __tests__/e2e && yarn install
            - save_cache:
                  paths:
                      - node_modules
                  key: v1-dependencies-{{ checksum "yarn.lock" }}
            - run:
                  name: Generate files
                  command: >-
                      source ~/.bashrc && nvm use 11 && node --version && cd __tests__/e2e
                      && yarn generate -c 3 -v 11
            - run:
                  name: Make scripts executable
                  command: >-
                      sudo chmod +x __tests__/e2e/dist/docker* && sudo chmod +x
                      __tests__/e2e/dist/node0/docker/testnet-e2e/entrypoint.sh && sudo
                      chmod +x __tests__/e2e/dist/node1/docker/testnet-e2e/entrypoint.sh
                      && sudo chmod +x
                      __tests__/e2e/dist/node2/docker/testnet-e2e/entrypoint.sh && sudo
                      chmod +x __tests__/e2e/dist/node0/ark.sh && sudo chmod +x
                      __tests__/e2e/dist/node1/ark.sh && sudo chmod +x
                      __tests__/e2e/dist/node2/ark.sh
            - run:
                  name: Docker init and start
                  command: cd __tests__/e2e/dist && ./docker-init.sh && ./docker-start.sh
            - run:
                  name: Wait 10 sec for docker containers to be up
                  command: sleep 10
            - run:
                  name: Run tests
                  command: >-
                      cd __tests__/e2e && sudo chown -R $USER:$USER ./dist/ && source
                      ~/.bashrc && nvm use 11 && yarn run-tests -s scenario1
            - run:
                  name: Output results - node0
                  when: always
                  command: >-
                      cat __tests__/e2e/dist/node0/output.log && cat
                      __tests__/e2e/dist/node0/errors.log
            - run:
                  name: Output results - node1
                  when: always
                  command: >-
                      cat __tests__/e2e/dist/node1/output.log && cat
                      __tests__/e2e/dist/node1/errors.log
            - run:
                  name: Output results - node2
                  when: always
                  command: >-
                      cat __tests__/e2e/dist/node2/output.log && cat
                      __tests__/e2e/dist/node2/errors.log
    test-node12-e2e:
        machine: true
        steps:
            - checkout
            - run:
                  name: Install nvm 12
                  command: source ~/.bashrc && nvm install 12 && nvm use 12
            - restore_cache:
                  keys:
                      - v1-dependencies-{{ checksum "yarn.lock" }}
                      - v1-dependencies-
            - run:
                  name: Install yarn
                  command: >-
                      curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add
                      - && echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo
                      tee /etc/apt/sources.list.d/yarn.list && sudo apt-get update && sudo
                      apt-get install yarn
            - run:
                  name: Docker swarm init
                  command: docker swarm init
            - run:
                  name: Install and build packages
                  command: >-
                      source ~/.bashrc && nvm use 12 && yarn && yarn bootstrap && yarn
                      build && cd __tests__/e2e && yarn install
            - save_cache:
                  paths:
                      - node_modules
                  key: v1-dependencies-{{ checksum "yarn.lock" }}
            - run:
                  name: Generate files
                  command: >-
                      source ~/.bashrc && nvm use 12 && node --version && cd __tests__/e2e
                      && yarn generate -c 3 -v 12
            - run:
                  name: Make scripts executable
                  command: >-
                      sudo chmod +x __tests__/e2e/dist/docker* && sudo chmod +x
                      __tests__/e2e/dist/node0/docker/testnet-e2e/entrypoint.sh && sudo
                      chmod +x __tests__/e2e/dist/node1/docker/testnet-e2e/entrypoint.sh
                      && sudo chmod +x
                      __tests__/e2e/dist/node2/docker/testnet-e2e/entrypoint.sh && sudo
                      chmod +x __tests__/e2e/dist/node0/ark.sh && sudo chmod +x
                      __tests__/e2e/dist/node1/ark.sh && sudo chmod +x
                      __tests__/e2e/dist/node2/ark.sh
            - run:
                  name: Docker init and start
                  command: cd __tests__/e2e/dist && ./docker-init.sh && ./docker-start.sh
            - run:
                  name: Wait 10 sec for docker containers to be up
                  command: sleep 10
            - run:
                  name: Run tests
                  command: >-
                      cd __tests__/e2e && sudo chown -R $USER:$USER ./dist/ && source
                      ~/.bashrc && nvm use 12 && yarn run-tests -s scenario1
            - run:
                  name: Output results - node0
                  when: always
                  command: >-
                      cat __tests__/e2e/dist/node0/output.log && cat
                      __tests__/e2e/dist/node0/errors.log
            - run:
                  name: Output results - node1
                  when: always
                  command: >-
                      cat __tests__/e2e/dist/node1/output.log && cat
                      __tests__/e2e/dist/node1/errors.log
            - run:
                  name: Output results - node2
                  when: always
                  command: >-
                      cat __tests__/e2e/dist/node2/output.log && cat
                      __tests__/e2e/dist/node2/errors.log
workflows:
    version: 2
    build_and_test:
        jobs:
            - test-node10-unit
            - test-node11-unit
            - test-node12-unit
            - test-node10-functional
            - test-node11-functional
            - test-node12-functional
            - test-node10-benchmark
            - test-node11-benchmark
            - test-node12-benchmark
            - test-node10-e2e
            - test-node11-e2e
            - test-node12-e2e
            - test-node10-integration
            - test-node11-integration
            - test-node12-integration
